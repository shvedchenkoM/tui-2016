<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<script type="text/javascript" src="js/paper-full.min.js"></script>
<script type="text/javascript" src="js_3/heneral.js"></script>
<script type="text/javascript" src="js_3/cell.js"></script>
<script type="text/javascript" src="js_3/gamemodel3.js"></script>
<div id="gameParam">
<p><strong>Введите размеры поля:</strong></p>
   <p>Кол-во колонок : <input type="number" min="4" max="40" value="8" id="col"/></p>
   <p>Кол-во строк : <input type="number" min="4" max="40" value="6" id="row"/></p>
   <p>Кол-во ходов : <input type="text" value="2" size="4" id="step"/><p>
   <p style="text-align: left" ><button id="step2Button">Продолжить</button>
</div>
<div id="playersName" style="display: none;">
     <p><strong>Введите имена игроков:</strong></p>
        <p>Имя первого : <input type="text" value="player1" id="name1"/></p>
        <p>Имя второго : <input type="text" value="player2" id="name2"/></p>
        <p style="text-align: left" ><button id="startButton">Начать игру</button>
</div>
<button id="castleButton">Make Castle</button>
<button id="finishTurnButton" disabled>Finish Turn</button>
<script type="text/paperscript" canvas="myCanvas">

var castleProto = document.getElementById('castleProto');
var townProto = document.getElementById('townProto');
var rock = document.getElementById('rock');
var river = document.getElementById('river');

var row = document.getElementById('row');
var col = document.getElementById('col');
var step2Button = document.getElementById('step2Button');
var startButton = document.getElementById('startButton');
var gameParam = document.getElementById('gameParam');
var name1 = document.getElementById('name1');
var name2 = document.getElementById('name2');
var castleButton = document.getElementById('castleButton');
var finishTurnButton = document.getElementById('finishTurnButton');


function showTurn(game){
  var path = new Path.Rectangle(10,10,30,30);
  path.strokeColor = 'black'
  path.fillColor = getPlayerColor(game.getTurn());
}

function getPlayerColor(value){
  return ['lightgray','yellow','green'][value];
}

function VCell(center, radius, coords) {
    var instance = this
    this.center = center
    this.path = new Path.RegularPolygon({
      center: center,
      sides: 6,
      radius: radius,
      rotation: 30,
      strokeColor: 'red',
      fillColor: 'lightgray',
      strokeWidth: 3
    })
//    this.path.vcell = this;
    this.coords = coords;
    project.importSVG(castleProto, function(item) {
      instance.castle = item;
      instance.castle.position = instance.center + [5,5];
      instance.castle.scaling = 0.8;
    });
    project.importSVG(townProto, function(item) {
      instance.town = item;
      instance.town.position = instance.center + [7,7];
      instance.town.scaling = 1;
    });
    project.importSVG(rock, function(item) {
      instance.rock = item;
      instance.rock.position = instance.center + [2,0];
      instance.rock.scaling = 0.8;
    });
    project.importSVG(river, function(item) {
      instance.river = item;
      instance.river.position = instance.center + [2,0];
      instance.river.scaling = 0.8;
    });

    this.group = new Group([this.path, instance.castle, instance.town, instance.rock, instance.river]);
    this.group.onMouseDown = function(event) {
        handleCellClick(instance.coords)
    };

    instance.onUpdate = function(cell) {
     instance.path.fillColor = getPlayerColor(cell.getPlayer());

      if ( cell.getHeneral() !== undefined ) {
        instance.path.fillColor = 'blue'
      }

      if (cell.isCastle() ) {
        instance.castle.visible = true;
        instance.castle.fillColor = [undefined, 'red','white'][cell.getPlayer()];
      }
      if (cell.isTown()) {
        instance.town.visible = true;
        instance.town.scaling = 1;
        instance.town.strokeWidth = 1;
        instance.town.strokeColor = 'black';
        instance.town.fillColor = [undefined, 'red','white'][cell.getPlayer()];
      }
      if (cell.isRocks()) {
        instance.rock.visible = true;
        instance.rock.scaling = 1;
        instance.rock.strokeWidth = 1;
        instance.rock.strokeColor = 'black';
        instance.rock.fillColor = 'brown';
      }
      if (cell.isRiver()) {
        instance.river.visible = true;
        instance.river.scaling = 1;
      }

    }
}


  // VCell.prototype.onUpdate = function( cell )

  function showCongr(msg){
    var text = new PointText({
      point: [400, 30],
      content: msg,
      fillColor: "red",
      fontFamily: 'Lucida Console',
      fontWeight: 'bold',
      fontSize: 25
    });
  }

  function drawe(radius) {

    var yradius = Math.sin(Math.PI / 3) * radius
    var fieldStart = [0, 50]
    for (var i = 0; i < game.rows; i++) {
      for (var j = 0; j < game.cols; j++) {
        var cellView ={} ;
          cellView = new VCell(
                      new Point(
                        fieldStart[0] + radius + 1.5 * j * radius
                        ,  fieldStart[1]  + yradius * (2 * i + 1) + (j % 2) * yradius
                      ),
                        radius, {"r": i, "c": j })

        game.cellSubscribe(cellView.onUpdate,i,j)
        cellView.onUpdate(game.field[i][j])
      }
    }

  }

  var hitOptions = {
    segments: true,
    stroke: true,
    fill: true,
    tolerance: 5
  }


  function handleCellClick(coords) {
    game.doCommand({
      code: 0,
      params: coords
    })

    // if (game.makeTurn( cell.coords.r, cell.coords.c)) {
    //  game.flipTurn();
    // }

    showTurn(game);
    if(game.isGameOver()){
      var c1 = game.countOfCells(1);
      var c2 = game.countOfCells(2);
      var a = game.getWinner();
      showGameParam();
      if(a !== 'draw')
      showCongr('Игрок ' + (['',name1.value,name2.value][a]) + '  выиграл!!!' + '( ' + c1 + ':' + c2 + ' )' ); else {
        showCongr('  (:НИЧЬЯ:)');
      }
    }
  }


  function logger(txt) {
    document.getElementById('log').innerHTML += txt + "<br/>"
  }

  var game;
  var steps = step.value;


  function startGame(){
    clearView();
    hideNamesPanel();
    var x = row.value;
    var y = col.value;
    game = new GameModel(x, y, steps);
    game.subscribe('generic',showGameState)
    game.subscribe('finishTurn', function() {
      finishTurnButton.disabled = false
    })

    game.subscribe('startTurn', function() {
      finishTurnButton.disabled = true
    })

    game.makearr()
    game.setInitPos([
      {r: x-2,c: 1},
      {r: 1, c: y-2}
    ])
    drawe(30);
    showTurn(game);
    game.beginNewTurn();
  }

  function showGameState(game) {
    if (game.activeHeneral !== undefined)
      console.log(game.activeHeneral.moves + ' hodov zalyshylos') ;
  }

  castleButton.addEventListener('click', function() {
    game.doCommand({code:2});
  })

  finishTurnButton.addEventListener('click', function() {
    game.doCommand({code:1});
  })

//////////////////////////////////////////////////////////////////////////////////

  startButton.addEventListener('click', startGame );
  step2Button.addEventListener('click', showNamesPanel )
  function clearView() {
    project.activeLayer.removeChildren();
    view.draw();
  }
  function hideGameParam() {
    gameParam.style = "display:none;";
  }
  function showGameParam() {
    gameParam.style = "";
    hideNamesPanel();
  }
  function showNamesPanel() {
    if(col.value < 5 || col.value > 21 || row.value < 5 || row.value > 21) {
      alert('NO');
      return;
    }
    hideGameParam();
    playersName.style = "";
  }
  function hideNamesPanel() {
    playersName.style = "display: none;";
  }

</script>
</head>
<body>
  <div style="display:block;"><span id="log" style="vertical-align:top"/></div>

	<canvas id="myCanvas" resize="true" height="700" width="1000" contenteditable="true"></canvas>
  <svg style="display:none;" id="castleProto" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 width="50px" height="50px" viewBox="0 0 800 800" xml:space="preserve">
<path d="M480,16v32h-32V16h-32v32h-32V16h-32v32v64l32,32v128h-32v-32h-64v32h-64v-32h-64v32h-32V144l32-32V48V16h-32v32H96V16H64
	v32H32V16H0v32v64l32,32v128v224h160v-64c0-35.375,28.656-64,64-64s64,28.625,64,64v64h160V272V144l32-32V48V16H480z M64,272v-48
	c0-8.875,7.156-16,16-16s16,7.125,16,16v48H64z M416,272v-48c0-8.875,7.156-16,16-16s16,7.125,16,16v48H416z"/>
</svg>

<svg style="display:none;" id="townProto" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
 width="50px" height="50px" viewBox="0 0 800 800" xml:space="preserve">
<path d="M480,16v32h-32V16h-32v32h-32V16h-32v32v64l32,32v128h-32v-32h-64v32h-64v-32h-64v32h-32V144l32-32V48V16h-32v32H96V16H64
v32H32V16H0v32v64l32,32v128v224h160v-64c0-35.375,28.656-64,64-64s64,28.625,64,64v64h160V272V144l32-32V48V16H480z"/>
</svg>

<svg style="display:none;" id="rock" xmlns="http://www.w3.org/2000/svg"
 version="1.1" width="50px" height="50px">
<polygon points="5,23 13,10 26,23" fill="#EA1C1C" />
<polygon points="13,23 26,1 39,23" fill="#EA1C1C" />
<polygon points="26,23 39,12 52,23" fill="#EA1C1C" />
</svg>

<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 45 45" enable-background="new 0 0 45 45" xml:space="preserve" style="display:none;" id="river">
	<path fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="
		M6.8,8.3c0.5,0.5,1.3,0.9,2.1,0.9h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6
		c0.3,0,0.6-0.1,0.9-0.1"/>
	<path fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="
		M2.2,16.7c0.2,0.1,0.5,0.1,0.7,0.1h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6c1.7,0,3-1.4,3-3
		c0,1.7,1.4,3,3,3h5"/>
	<path fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="
		M3.6,31.9h4.9c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h5.6c1.7,0,3-1.4,3-3c0,1.7,1.4,3,3,3h3.6"/>
	<path fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="
		M35,39.5h-2.8c-1.7,0-3-1.4-3-3c0,1.7-1.4,3-3,3h-5.6c-1.7,0-3-1.4-3-3c0,1.7-1.4,3-3,3H10"/>
	<path fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" d="
		M43.6,24.3c-1.5-0.2-2.7-1.4-2.7-3c0,1.7-1.4,3-3,3h-5.6c-1.7,0-3-1.4-3-3c0,1.7-1.4,3-3,3h-5.6c-1.7,0-3-1.4-3-3c0,1.7-1.4,3-3,3
		H8.9c-1.7,0-3-1.4-3-3c0,1.7-1.4,3-3,3H1.5"/>

		<circle fill="none" stroke="#00BCF2" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" stroke-miterlimit="10" cx="22.5" cy="22.5" r="21.1"/>
</svg>


</body>
</html>
